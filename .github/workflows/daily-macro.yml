name: Daily Macro Report

on:
  workflow_dispatch:   # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  schedule:
    # ë§¤ì¼ UTC 22:00 â†’ í•œêµ­ì‹œê°„ ì˜¤ì „ 7ì‹œ
    - cron: "0 22 * * *"

permissions:
  contents: write   # ğŸ”¥ ìë™ ì»¤ë°‹/í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìˆ˜

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ë ˆí¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ íŒŒì´ì¬ ì„¸íŒ…
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # requirements.txt íŒŒì¼ì— ëª…ì‹œëœ ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

      # 4ï¸âƒ£ ë””ë ‰í† ë¦¬ ë³´ì¥ (ğŸ’¥ ì´ê±° ì•ˆ í•˜ë©´ ì—ëŸ¬ë‚¨)
      - name: Ensure required directories exist
        run: |
          mkdir -p reports
          mkdir -p data

      # 5ï¸âƒ£ ìœ ë™ì„±(TGA/RRP) ë°ì´í„° ì—…ë°ì´íŠ¸
      - name: Fetch liquidity data (TGA/RRP)
        run: |
          export PYTHONPATH="$GITHUB_WORKSPACE"
          python scripts/fetch_liquidity_data.py
    

      # 5ï¸âƒ£ ë°ì¼ë¦¬ ë¦¬í¬íŠ¸ ìƒì„±
      - name: Run report generator
        run: |
          export PYTHONPATH="$GITHUB_WORKSPACE"
          python scripts/generate_report.py
      
      # 6ï¸âƒ£ ê²°ê³¼ ìë™ ì»¤ë°‹ & í‘¸ì‹œ
      - name: Commit and push report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add reports/*.md || true
          git add data/liquidity_data.csv || true
          
          # ë³€ê²½ ì—†ìœ¼ë©´ ì»¤ë°‹ ì•ˆ í•¨
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: auto-generate daily macro report"
          git push
